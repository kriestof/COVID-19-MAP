<!-- Copyright 2020 Krzysztof Piwoński <piwonski.kris@gmail.com> -->
<!--
    This file is a part of COVID-19 chart.

    COVID-19 chart is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    COVID-19 chart is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
 -->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160718087-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-160718087-1');
  </script>

  <title>COVID-19 chart and map</title>
  <meta name="description" content="Check how COVID-19 disease develops worldwide.">
  <meta name="keywords" content="COVID-19,chart,map">
  <meta name="author" content="Krzysztof Piwoński">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
<h1>History of COVID19 by country</h1>

<div id="inner">
  <div>
    <div id="formula-menu">
      <div class="left-menu">
        <strong>Choose indicator:</strong>
        <select id="predefined-formulas">
          <option value="infected">infected</option>
          <option value="recovered">recovered</option>
          <option value="deaths">deaths</option>
          <option value="infected - recovered - deaths">currently infected</option>
          <option value="recovered ./ infected * 10^2">recovered rate</option>
          <option value="deaths ./ infected * 10^2">death rate</option>
          <option value="round(infected ./ WB_SP_POP_TOTL * 10^6)">infected per 1 mln.</option>
        </select>
      </div>

      <div class="right-menu">
        <span class="help-text"><strong>or type: </strong> <br> <a href="/help.html">help?</a></span>
        <div id="formula-wrapper">
          <input type="text" id="formula" value="infected">
          <div id="formula-error"></div>
        </div>
      </div>
    </div>

    <div id="map">
      <div id="map-menu">
        <span><strong>Choose date:</strong></span>
        <input type="range" min="0" max="22" id="date">
        <strong>Date:</strong> <span id="selected-date"></span>
      </div>
      <div class="right-menu">
      <strong>Region:</strong>
        <select id="region">
          <option default value="world">World</option>
          <option value="europe">Europe</option>
          <option value="asia">Asia</option>
          <option value="africa">Africa</option>
          <option value="samerica">South America</option>
          <option value="namerica">North America</option>
          <option value="australia">Australia</option>
        </select>

        <strong>Mode:</strong>
        <select id="mode">
          <option default value="all">Indicator</option>
          <option value="increase">Daily increase</option>
        </select>
      </div>

      <div id="map-outer">
        <a href="">Download png</a>
      </div>
    </div>
  </div>

  <div>
    <div id="scale-lim-menu">
      <strong>xlim:</strong> <input id="xlim-min" type="date">:<input id="xlim-max" type="date">
      <div id="ylim-menu">
        <strong>ylim:</strong> <input id="ylim-min" type="number">:<input id="ylim-max" type="number">
      </div>

      <button type="button" name="button" id="set-scale-lim">Set</button>
    </div>


    <div id="chart">
      <div id="chart-menu">
        <div class="left-menu">
          <input type="text" id="search-country" placeholder="Type country name">
          <div id="result"><ul></ul></div>
          <a id="download-chart" href="">Download png</a>
        </div>

        <div class="right-menu">
          <strong>scale type:</strong>
          <select id="choose-scale">
            <option value="symlog">symlog</option>
            <option value="linear">linear</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="footer">
<span class="left">COVID-19 chart and map. Copyright 2020 Krzysztof Piwoński.</span> <a href="https://github.com/kriestof/COVID-19-chart" target="_parent">source code</a>
<span class="right">Based on data collected by <a href="https://github.com/CSSEGISandData/COVID-19" target="_parent">Johns Hopkins CSSE</a> and <a href="https://data.worldbank.org/" target="_parent">World Bank</a></span>.
<div style="clear:both;"></div>
</div>

<script src="https://unpkg.com/d3@5"></script>
<script src="https://unpkg.com/d3-geo-projection@2.8"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/mathjs@6.6.2/dist/math.min.js"></script>
<script src="chart.js"></script>
<script src="map.js"></script>
<script src="utils.js"></script>
<script>
let mapSvg = d3.select("#map-outer").append("svg");
let chartSvg = d3.select("#chart").append("svg")

let chart = undefined
let map = undefined
let mode = d3.select("#mode").node().value
let region = d3.select("#region").node().value
let data = {}
let dates = undefined
let countryNames = undefined
let savedFormula = undefined
let scale = d3.select("#choose-scale").node().value
let yDomain = undefined

d3.select("#choose-scale").on("change", function() {changeScale(this.value)})

d3.select("#set-scale-lim").on("click", function() {
  changeScaleLims(
    [new Date(d3.select("#xlim-min").node().value) - 1000*60*60*24, new Date(d3.select("#xlim-max").node().value)],
    [d3.select("#ylim-min").node().value, d3.select("#ylim-max").node().value]
  )
})

d3.select("#mode").on("change", function() {
  mode = this.value
  changeData()
})

d3.select("#region").on("change", function() {
  region = this.value
  map.displayRegion(region)
})

d3.select("#predefined-formulas").on("change", function() {
  d3.select("#formula").node().value = this.value
  changeData(this.value)
})

function changeScaleLims(xlim, ylim) {
  chart.setYDomain(ylim[0], ylim[1])
  chart.x.domain(xlim)
  map.setScaleDomain(ylim[0], ylim[1])
  changeData(undefined, true)
}

function changeScale(scale) {
  chart.changeScale(scale)
  chart.setYDomain(d3.select("#ylim-min").node().value, d3.select("#ylim-max").node().value)
  changeData(undefined, true)
}

function changeData(formula, ommitDefaultScales) {
  if (!formula)
    formula = savedFormula

  d3.select("#formula").attr("disabled", "true")
  return fetchWbankIndicators(formula).then(function() {
    let evalData = undefined
    try {evalData = math.evaluate(formula, data)}
    catch (err) { return Promise.reject(err.message)}

    if (mode === "increase") {
      let up = evalData.subset(math.index(math.range(0, evalData.size()[0]), math.range(1, evalData.size()[1])))
      let down = evalData.subset(math.index(math.range(0, evalData.size()[0]), math.range(0, evalData.size()[1]-1)))
      evalData = math.subtract(up, down)
      evalData = math.concat(math.zeros(evalData.size()[0]).resize([evalData.size()[0], 1]), evalData)
    }

    savedFormula = formula

    if (chart.x.domain()[0].getFullYear() === 2000) {
      d3.select("#xlim-min").node().valueAsDate = UTCDate(dates[0])
      d3.select("#xlim-max").node().valueAsDate = UTCDate(dates[dates.length-1])
      chart.x.domain([UTCDate(dates[0]) - 1000*60*60*24, UTCDate(dates[dates.length-1])])
    }

    if (!ommitDefaultScales) {
      maxVal =  math.max(evalData.toArray().map((arr) => arr.filter((x) => !Number.isNaN(x) && Number.isFinite(x))))
      minVal =  math.min(evalData.toArray().map((arr) => arr.filter((x) => !Number.isNaN(x) && Number.isFinite(x))))
      chart.setYDomain(minVal, maxVal)

      map.setScaleDomain(minVal, maxVal)
      d3.select("#ylim-min").node().value = minVal
      d3.select("#ylim-max").node().value = maxVal
    }

    map.changeData(evalData)
    chart.changeData(evalData)
    d3.select("#formula").attr("disabled", null)
    d3.select("#formula").attr("class", "")
    d3.select("#formula-error").text("")
  }).catch(handleFormulaError)
}

function handleFormulaError(err) {
  d3.select("#formula").attr("class", "error")
  d3.select("#formula-error").text(err)
  d3.select("#formula-error").attr("title", err)
  d3.select("#formula").attr("disabled", null)
}

document.getElementById("formula").addEventListener("keyup", function(e) {
  if (e.keyCode === 13)
    changeData(this.value)
})

let promises = [
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
]

Promise.all(promises).then(function(res) {
  [data.infected, data.recovered, data.deaths] = res
  dates = data.infected.columns.slice(4, data.infected.columns.length)
  convertHopkins("infected")
  convertHopkins("recovered")
  convertHopkins("deaths")
}).then(function() {
  map = worldMap(countryNames, dates, mapSvg)
  chart = new Chart(countryNames, dates, chartSvg)
  return fetchWbankIndicators(d3.select("#formula").node().value)
    .catch(handleFormulaError).then(map.initMap)
})
.then(function() {
  changeData(d3.select("#formula").node().value)
})
</script>
