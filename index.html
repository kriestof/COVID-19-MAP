<!-- Copyright 2020 Krzysztof Piwoński <piwonski.kris@gmail.com> -->
<!--
    This file is a part of COVID-19 chart.

    COVID-19 chart is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    COVID-19 chart is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
 -->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160718087-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-160718087-1');
  </script>

  <title>COVID-19 chart and map</title>
  <meta name="description" content="Check how COVID-19 disease develops worldwide.">
  <meta name="keywords" content="COVID-19,chart,map">
  <meta name="author" content="Krzysztof Piwoński">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
<h1>History of COVID19 by country</h1>

<div id="formula-menu">
  <div class="left-menu">
    <strong>Choose indicator:</strong>
    <select id="predefined-formulas">
      <option value="infected">infected</option>
      <option value="recovered">recovered</option>
      <option value="deaths">deaths</option>
      <option value="infected - recovered">currently infected</option>
      <option value="recovered ./ infected * 10^2">recovered rate</option>
      <option value="deaths ./ infected * 10^2">death rate</option>
      <option value="round(infected ./ POP * 10^6)">infected per 1 mln.</option>
    </select>
  </div>

  <div class="right-menu">
    <strong>or type:</strong>
    <input type="text" id="formula" value="infected">

    <div id="formula-error"></div>
  </div>

</div>

<div id="inner">
  <div id="map">
    <div id="map-menu">
      <span><strong>Choose date:</strong></span>
      <input type="range" min="0" max="22" id="date">
      <strong>Date:</strong> <span id="selected-date"></span>
    </div>
    <div id="right-menu">
    <strong>Region:</strong>
      <select id="region">
        <option default value="world">World</option>
        <option value="europe">Europe</option>
      </select>

      <strong>Mode:</strong>
      <select id="mode">
        <option default value="all">All cases</option>
        <option value="new">Daily new cases</option>
      </select>
    </div>

    <div id="map-outer">
      <a href="">Download png</a>
    </div>
  </div>
  <div id="chart">
    <div id="chart-menu">
      <input type="text" id="search-country" placeholder="Type country name">
      <div id="result"><ul></ul></div>
      <a id="download-chart" href="">Download png</a>
    </div>
  </div>
</div>


<div id="footer">
<span class="left">COVID-19 chart and map. Copyright 2020 Krzysztof Piwoński.</span> <a href="https://github.com/kriestof/COVID-19-chart" target="_parent">source code</a>
<span class="right">Based on <a href="https://github.com/CSSEGISandData/COVID-19" target="_parent">data</a> collected by Johns Hopkins CSSE.</span>
<div style="clear:both;"></div>
</div>

<script src="https://unpkg.com/d3@5"></script>
<script src="https://unpkg.com/d3-geo-projection@2.8"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/mathjs@6.6.2/dist/math.min.js"></script>
<script src="chart.js"></script>
<script src="map.js"></script>
<script src="utils.js"></script>
<script>
let mapSvg = d3.select("#map-outer").append("svg");
let chartSvg = d3.select("#chart").append("svg")
let confirmedData = undefined

let chart = undefined
let map = undefined
let mode = d3.select("#mode").node().value
let region = d3.select("#region").node().value
let data = {}

d3.select("#mode").on("change", function() {
  mode = this.value
  map.displayMapForDate()
  chart.drawLinesChart()
})

d3.select("#region").on("change", function() {
  region = this.value
  map.displayRegion(region)
})

d3.select("#predefined-formulas").on("change", function() {
  d3.select("#formula").node().value = this.value
  map.changeData(math.evaluate(this.value, data))
  chart.changeData(math.evaluate(this.value, data))
})


document.getElementById("formula").addEventListener("keyup", function(e) {
  if (e.keyCode === 13) {
    try {
      map.changeData(math.evaluate(this.value, data))
      chart.changeData(math.evaluate(this.value, data))
      d3.select("#formula").attr("class", "")
      d3.select("#formula-error").text("")
    } catch(err) {
      d3.select("#formula").attr("class", "error")
      d3.select("#formula-error").text(err.message)
    }
  }
})

let promises = [
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"),
  d3.csv("data/wbank_indicators.csv")
]

function convertHopkins(indicatorName) {
  removeCountries = new Set([
    "Congo (Brazzaville)",
    "Diamond Princess",
    "Holy See",
    "MS Zaandam",
    "Saint Kitts and Nevis",
    "Saint Lucia",
    "Saint Vincent and the Grenadines",
    "Taiwan*"
  ])

  columns = data[indicatorName].columns
  data[indicatorName] = data[indicatorName].filter(function(obj) { return !removeCountries.has(obj["Country/Region"])})
  data[indicatorName].columns = columns

  const namesMap = {
    "US": "United States of America",
    "Korea, South": "South Korea",
    "Korea, North": "North Korea",
    "Bosnia and Herzegovina": "Bosnia and Herz.",
    "North Macedonia": "Macedonia",
    "Dominican Republic": "Dominican Rep.",
    "Congo (Kinshasa)": "Dem. Rep. Congo",
    "Burma": "Myanmar",
    "Central African Republic": "Central African Rep.",
    "Cote d'Ivoire": "Côte d'Ivoire",
    "Dominican Republic": "Dominican Rep.",
    "Eswatini": "eSwatini",
    "Equatorial Guinea": "Eq. Guinea"
  }

  data[indicatorName].map(function(d) {
    if (d["Country/Region"] in namesMap)
      d["Country/Region"] = namesMap[d["Country/Region"]]
  })

  data[indicatorName].sort((objX, objY) => objX["Country/Region"] > objY["Country/Region"])

  data[indicatorName] = d3.nest()
    .key((d) => d["Country/Region"])
    .rollup(function(v) {
      dates = data[indicatorName].columns.slice(4, data[indicatorName].columns.length)
      res = {}

      for (date of dates)
        res[date] = d3.sum(v, (d) => parseFloat(d[date]))
      return res
    })
    .entries(data[indicatorName])

  countryNames = data[indicatorName].map(obj => obj.key)
  data[indicatorName] = math.matrix(data[indicatorName].map((country) =>
    Object.keys(country.value).map((key) => country.value[key])
  ))
}

function fetchWbankIndicators(formula) {
  let pr = math.parse(formula)
  let wbankIndicators = []

  pr.traverse(function(node) {
    if (node.isSymbolNode && node.name.startsWith("WB_"))
      wbankIndicators.push(node.name.slice(3).replace(/_/g, "."))
  })

  countryNamesSet = new Set(countryNames)

  d3.json(`http://api.worldbank.org/v2/country/all/indicator/${wbankIndicators.join(";")}?format=json&date=2018&source=2&Per_page=10000`)
    .then(function(wbankData) {
      const namesMap = {
        "Bahamas, The": "Bahamas",
        "Bosnia and Herzegovina": "Bosnia and Herz.",
        "Brunei Darussalam": "Brunei",
        "Central African Republic": "Central African Rep.",
        "Congo, Dem. Rep.": "Dem. Rep. Congo",
        "Congo, Rep.": "Congo",
        "Cote d'Ivoire": "Côte d'Ivoire",
        "Czech Republic": "Czechia",
        "Dominican Republic": "Dominican Rep.",
        "Egypt, Arab Rep.": "Egypt",
        "Equatorial Guinea": "Eq. Guinea",
        "Eswatini": "eSwatini",
        "Gambia, The": "Gambia",
        "Iran, Islamic Rep.": "Iran",
        "Kyrgyz Republic": "Kyrgyzstan",
        "Lao PDR": "Laos",
        "North Macedonia": "Macedonia",
        "Korea, Dem. People’s Rep.": "North Korea",
        "Russian Federation": "Russia",
        "South Sudan": "S. Sudan",
        "Slovak Republic": "Slovakia",
        "Solomon Islands": "Solomon Is.",
        "Korea, Rep.": "South Korea",
        "Syrian Arab Republic": "Syria",
        "United States": "United States of America",
        "Venezuela, RB": "Venezuela",
        "Yemen, Rep.": "Yemen"
      }

      wbankData[1].map(function(x) {if(x.country.value in namesMap) x.country.value = namesMap[x.country.value]})
      wbankData = wbankData[1].filter((x) => countryNamesSet.has(x.country.value))
      wbankData = d3.nest().key((d) => d.indicator.id).object(wbankData)

      for (let indicatorName of wbankIndicators) {
        wbankIndicator = wbankData[indicatorName]
        wbankIndicator.sort((x, y) => x.country.value > y.country.value)
        wbankIndicator = wbankIndicator.map((x) => x.value)

        data["WB_"+indicatorName.replace(/\./g, "_")] = math.matrix(wbankIndicator.map(
          function(val) {if(val === null) val = NaN; return math.multiply(math.ones(dates.length), val);}
        ))
      }
    })
}

function processWbankIndicators() {
  countryNamesSet = new Set(countryNames)
  columns = wbankIndicators.columns
  wbankIndicators = wbankIndicators.filter((obj) => countryNamesSet.has(obj.countryName))
  wbankIndicators.columns = columns

  for (let indicatorName of wbankIndicators.columns)
    data[indicatorName] = math.matrix(wbankIndicators.map((countryObj) =>
      math.multiply(math.ones(dates.length), parseFloat(countryObj[indicatorName]))))
}

let dates = undefined
let countryNames = undefined
let wbankIndicators = undefined

Promise.all(promises).then(function(res) {
  [data.infected, data.recovered, data.deaths] = res

  dates = data.infected.columns.slice(4, data.infected.columns.length)
  convertHopkins("infected")
  convertHopkins("recovered")
  convertHopkins("deaths")

  wbankIndicators = res[3]
  processWbankIndicators(res[3])
}).then(function() {
  map = worldMap(countryNames, dates, mapSvg)
  chart = new Chart(countryNames, dates, chartSvg)
  chart.changeData(math.evaluate(d3.select("#formula").node().value, data))
  return map.initMap()
})
.then(function() {
  map.changeData(math.evaluate(d3.select("#formula").node().value, data))
})
</script>
