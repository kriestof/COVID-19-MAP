<!-- Copyright 2020 Krzysztof Piwoński <piwonski.kris@gmail.com> -->
<!--
    This file is a part of COVID-19 chart.

    COVID-19 chart is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    COVID-19 chart is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
 -->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160718087-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-160718087-1');
  </script>

  <title>COVID-19 chart and map</title>
  <meta name="description" content="Check how COVID-19 disease develops worldwide.">
  <meta name="keywords" content="COVID-19,chart,map">
  <meta name="author" content="Krzysztof Piwoński">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
<h1>History of COVID19 by country</h1>

<div id="formula-menu">
  <div class="left-menu">
    <strong>Choose indicator:</strong>
    <select id="predefined-formulas">
      <option value="infected">infected</option>
      <option value="recovered">recovered</option>
      <option value="deaths">deaths</option>
      <option value="infected - recovered">currently infected</option>
      <option value="recovered ./ infected * 10^2">recovered rate</option>
      <option value="deaths ./ infected * 10^2">death rate</option>
      <option value="round(infected ./ WB_SP_POP_TOTL * 10^6)">infected per 1 mln.</option>
    </select>
  </div>

  <div class="right-menu">
    <span class="help-text"><strong>or type: </strong> <br> <a href="/help.html">help?</a></span>
    <input type="text" id="formula" value="infected">

    <div id="formula-error"></div>
  </div>

</div>

<div id="inner">
  <div id="map">
    <div id="map-menu">
      <span><strong>Choose date:</strong></span>
      <input type="range" min="0" max="22" id="date">
      <strong>Date:</strong> <span id="selected-date"></span>
    </div>
    <div id="right-menu">
    <strong>Region:</strong>
      <select id="region">
        <option default value="world">World</option>
        <option value="europe">Europe</option>
      </select>

      <strong>Mode:</strong>
      <select id="mode">
        <option default value="all">All cases</option>
        <option value="new">Daily new cases</option>
      </select>
    </div>

    <div id="map-outer">
      <a href="">Download png</a>
    </div>
  </div>
  <div id="chart">
    <div id="chart-menu">
      <input type="text" id="search-country" placeholder="Type country name">
      <div id="result"><ul></ul></div>
      <a id="download-chart" href="">Download png</a>
    </div>
  </div>
</div>


<div id="footer">
<span class="left">COVID-19 chart and map. Copyright 2020 Krzysztof Piwoński.</span> <a href="https://github.com/kriestof/COVID-19-chart" target="_parent">source code</a>
<span class="right">Based on data collected by <a href="https://github.com/CSSEGISandData/COVID-19" target="_parent">Johns Hopkins CSSE</a> and <a href="https://data.worldbank.org/" target="_parent">World Bank</a></span>.
<div style="clear:both;"></div>
</div>

<script src="https://unpkg.com/d3@5"></script>
<script src="https://unpkg.com/d3-geo-projection@2.8"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/mathjs@6.6.2/dist/math.min.js"></script>
<script src="chart.js"></script>
<script src="map.js"></script>
<script src="utils.js"></script>
<script>
let mapSvg = d3.select("#map-outer").append("svg");
let chartSvg = d3.select("#chart").append("svg")
let confirmedData = undefined

let chart = undefined
let map = undefined
let mode = d3.select("#mode").node().value
let region = d3.select("#region").node().value
let data = {}
let dates = undefined
let countryNames = undefined

d3.select("#mode").on("change", function() {
  mode = this.value
  map.displayMapForDate()
  chart.drawLinesChart()
})

d3.select("#region").on("change", function() {
  region = this.value
  map.displayRegion(region)
})

d3.select("#predefined-formulas").on("change", function() {
  d3.select("#formula").node().value = this.value
  changeData(this.value)
})

function changeData(formula) {
  d3.select("#formula").attr("disabled", "true")
  return fetchWbankIndicators(formula).then(function() {
    map.changeData(math.evaluate(formula, data))
    chart.changeData(math.evaluate(formula, data))
    d3.select("#formula").attr("disabled", null)
  })
}

document.getElementById("formula").addEventListener("keyup", function(e) {
  if (e.keyCode === 13) {
    try {
      let formula = this.value
      changeData(formula).then(function() {
        d3.select("#formula").attr("class", "")
        d3.select("#formula-error").text("")
      })
    } catch(err) {
      d3.select("#formula").attr("class", "error")
      d3.select("#formula-error").text(err.message)
    }
  }
})

let promises = [
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"),
  d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
]

Promise.all(promises).then(function(res) {
  [data.infected, data.recovered, data.deaths] = res
  dates = data.infected.columns.slice(4, data.infected.columns.length)
  convertHopkins("infected")
  convertHopkins("recovered")
  convertHopkins("deaths")
}).then(function() {
  map = worldMap(countryNames, dates, mapSvg)
  chart = new Chart(countryNames, dates, chartSvg)
  return fetchWbankIndicators(d3.select("#formula").node().value).then(map.initMap)
})
.then(function() {
  changeData(d3.select("#formula").node().value)
})
</script>
